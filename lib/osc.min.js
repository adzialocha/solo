/*! osc-js - v0.1.1 - 2014-08-10 by marmorkuchen.net */
!function(a){"use strict";function b(a){return"[object Array]"===Object.prototype.toString.call(a)}function c(a){return"number"==typeof a&&a%1===0}function d(){var a=new Date;return a.getTime()}function e(a){var b="";return"object"==typeof a?b="/"+a.join("/"):(b=a,b.length>1&&"/"===b[b.length-1]&&(b=b.slice(0,b.length-1)),b.length>1&&"/"!==b[0]&&(b="/"+b)),b}function f(a){var b;return b=a.replace(/\./g,"\\."),b=b.replace(/\(/g,"\\("),b=b.replace(/\)/g,"\\)"),b=b.replace(/\{/g,"("),b=b.replace(/\}/g,")"),b=b.replace(/\,/g,"|"),b=b.replace(/\[\!/g,"[^"),b=b.replace(/\?/g,"."),b=b.replace(/\*/g,".*")}var g={SOCKET:{IS_NOT_INITALIZED:-1,IS_CONNECTING:0,IS_OPEN:1,IS_CLOSING:2,IS_CLOSED:3}},h={discardLateMessages:!1},i="#bundle",j="127.0.0.1",k=8e3,l=function(){this.data=[],this.length=0};l.prototype.add=function(a){var b=a.encode();return this.length=this.length+b.length,this.data.push(b),!0},l.prototype.merge=function(){var a=new Int8Array(this.length),b=0;return this.data.forEach(function(c){a.set(c,b),b+=c.length}),a};var m=function(){return this._callbackHandlers={open:[],error:[],close:[]},this._addressHandlers={},this._uuid=-1,!0};m.prototype.on=function(a,c){var d,f,g,h;if("string"!=typeof a&&!b(a)||"function"!=typeof c)throw"OSCEventHandler Error: on expects string/array as eventName and function as callback";if(d=(++this._uuid).toString(),g={token:d,callback:c},"string"==typeof a&&a in this._callbackHandlers)return this._callbackHandlers[a].push(g),d;if(f=e(a),h=new RegExp(/[#*\s\[\],\/{}|\?]/g),h.test(f.split("/").join("")))throw"OSCEventHandler Error: address string contains invalid characters";return f in this._addressHandlers||(this._addressHandlers[f]=[]),this._addressHandlers[f].push(g),d},m.prototype.off=function(a,c){var d,f,g;if("string"!=typeof a&&!b(a)||!c)throw"OSCEventHandler Error: off expects string/array as eventName and a proper token";return f=!1,"string"==typeof a&&this._callbackHandlers[a]?(g=this._callbackHandlers,d=a):(d=e(a),g=this._addressHandlers),d in g&&g[d].forEach(function(a,b){a.token===c&&(g[d].splice(b,1),f=!0)}),f},m.prototype.notify=function(a,b){var c,d,g,h;if("string"!=typeof a)throw"OSCEventHandler Error: notify expects a string";if(this._callbackHandlers[a])return this._callbackHandlers[a].forEach(function(a){a.callback(b)}),!0;if(0===a.length||"/"!==a[0])throw"OSCEventHandler Error: notify expects a proper address starting with /";return d=Object.keys(this._addressHandlers),c=this,d.forEach(function(d){g=new RegExp(f(e(a)),"g"),h=g.test(d),h&&d.length===g.lastIndex&&c._addressHandlers[d].forEach(function(a){a.callback(b)})}),!0},m.prototype.notifyLater=function(b,c,e){var f,g,i;return i=c,i.timestamp=e.milliseconds,f=d(),f>=e.milliseconds?h.discardLateMessages||this.notify(b,i):(g=this,a.setTimeout(function(){g.notify(b,i)},e.milliseconds-f)),!0};var n=function(){this._socket=null};n.prototype.connect=function(a,b){if(!a||!b)throw"OSCSocket Error: missing WebSocket address or port";return this._socket&&this.disconnect(),this._socket=new WebSocket("ws://"+a+":"+b),this._socket.binaryType="arraybuffer",this._socket.onopen=function(a){s.notify("open",a)},this._socket.onclose=function(a){s.notify("close",a)},this._socket.onerror=function(a){s.notify("error",a)},this._socket.onmessage=function(a){var b=new p;b.decode(a.data)},!0},n.prototype.disconnect=function(){return this._socket.close(),!0},n.prototype.status=function(){return this._socket?this._socket.readyState:g.SOCKET.IS_NOT_INITALIZED},n.prototype.send=function(a){if(this._socket)return a&&a.buffer&&a.buffer instanceof ArrayBuffer?(this._socket.send(a.buffer),!0):!1;throw"OSCSocket Error: WebSocket is not ready to send OSC data"};var o={};o.OSCString=function(a){this.value=a||"",this.offset=0},o.OSCString.prototype.decode=function(a,b){for(var c,d,e,f=new Int8Array(a),g=b;f[g]&&g<f.length;)g++;if(g===f.length)throw"OSCMessage Error: malformed not ending OSC String";for(d=f.subarray(b,g),e="",c=0;c<d.length;c++)e+=String.fromCharCode(d[c]);return this.offset=4*Math.ceil((g+1)/4),this.value=e,this.offset},o.OSCString.prototype.encode=function(){for(var a=4*Math.ceil((this.value.length+1)/4),b=new Array(a),c=0;a>c;c++)b[c]=this.value.charCodeAt(c)||0;return new Int8Array(b)},o.Int32=function(a){this.value=a||0,this.offset=0},o.Int32.prototype.decode=function(a,b){var c=new DataView(a,b,4);return this.value=c.getInt32(0),this.offset=b+4,this.offset},o.Int32.prototype.encode=function(){var a=new DataView(new ArrayBuffer(4));return a.setInt32(0,this.value),new Int8Array(a.buffer)},o.Float32=function(a){this.value=a||0,this.offset=0},o.Float32.prototype.decode=function(a,b){var c=new DataView(a,b,4);return this.value=c.getFloat32(0),this.offset=b+4,this.offset},o.Float32.prototype.encode=function(){var a=new DataView(new ArrayBuffer(4));return a.setFloat32(0,this.value),new Int8Array(a.buffer)},o.OSCBlob=function(a){this.value=a||new Blob,this.offset=0},o.OSCBlob.prototype.decode=function(a,b){var c=new DataView(a,b,4),d=c.getInt32(0),e=a.slice(b+4,b+4+d);return this.value=new Blob([e]),this.offset=b+4+d,this.offset},o.OSCBlob.prototype.encode=function(){var a=4*Math.ceil((this.value.size+1)/4),b=new DataView(new ArrayBuffer(a+4));return b.setInt32(0,this.value.size),b.setInt32(4,this.value),new Int8Array(b.buffer)},o.OSCTimeTag=function(){this.value="",this.seconds=0,this.fraction=0,this.offset=0,this.milliseconds=0},o.OSCTimeTag.prototype.update=function(a){var b;b=a instanceof Date?a.getTime():a;var c=(b/1e3).toString();return this.seconds=parseInt(c.split(".")[0],10),this.fraction=parseInt(c.split(".")[1],10),this.milliseconds=b,this.value=this.seconds+"."+this.fraction,!0},o.OSCTimeTag.prototype.decode=function(a,b){var c=new DataView(a,b,8);return this.seconds=c.getInt32(0),this.fraction=c.getInt32(4),this.milliseconds=1e3*this.seconds,this.value=this.seconds+"."+this.fraction,this.offset=b+8,this.offset},o.OSCTimeTag.prototype.encode=function(){var a=new DataView(new ArrayBuffer(8));return a.setInt32(0,this.seconds),a.setInt32(4,this.fraction),new Int8Array(a.buffer)};var p=function(){return!0};p.prototype.decode=function(a,b){var c,d,e;if(a.byteLength%4!==0)throw"OSCPackage Error: byteLength has to be a multiple of four";if(c=new o.OSCString,c.decode(a,0),c.value===i){if(e=new q,e.decode(a),b&&e.timeTag.value<b.value)throw"OSCPackage Error: timetag of enclosing bundle is past timestamp of enclosed ones";return e}return d=new r,d.decode(a),b?s.notifyLater(d.addressPattern,d,b):s.notify(d.addressPattern,d),d},p.prototype.encode=function(a){if(a instanceof r){if(0===a.address.length)throw"OSCPacket Error: cant encode OSCMessage since address is empty";return a.encode()}return a instanceof q?a.encode():!1};var q=function(){var a,d;if(this.timeTag=new o.OSCTimeTag,this.bundleElements=[],arguments.length>0)if(c(arguments[0])||arguments[0]instanceof Date)this.timeTag.update(arguments[0]);else{if(!b(arguments[0]))throw"OSCBundle Error: first argument of constructor must be array of OSCMessages or TimeTag";for(d=arguments[0].length,a=0;d>a;a++){if(!(arguments[0][a]instanceof r))throw"OSCBundle Error: argument must be an OSCMessage";this.bundleElements.push(arguments[0][a])}arguments.length>1&&(c(arguments[1])||arguments[1]instanceof Date)&&this.timeTag.update(arguments[1])}return!0};q.prototype.timestamp=function(a){if(!a)return this.timeTag;if(!(c(a)||a instanceof Date))throw"OSCBundle Error: timetag must be an integer (milliseconds) or Date instance";this.timeTag.update(a)},q.prototype.add=function(a){if(!a||!(a instanceof r||a instanceof q))throw"OSCBundle Error: proper OSCMessage needed for bundling";this.bundleElements.push(a)},q.prototype.decode=function(a){var b,c,d,e;c=new o.OSCTimeTag,b=c.decode(a,8),this.timeTag=c;do d=new o.Int32,b=d.decode(a,b),d.value>0&&(e=new p,this.bundleElements.push(e.decode(a.slice(b,b+d.value),c))),b+=d.value;while(b<a.byteLength);return this},q.prototype.encode=function(){var a,b;return a=new l,a.add(new o.OSCString(i)),a.add(this.timeTag),this.bundleElements.forEach(function(c){b=c.encode(),a.add(new o.Int32(b.length)),a.add(c)}),a.merge()};var r=function(){var a,f,g;if(this.addressPattern="",this.typesString="",this.args=[],this.timestamp=d(),f=arguments.length,f>0){if("string"!=typeof arguments[0]&&!b(arguments[0]))throw"OSC.Message Error: first argument (path) must be a string or array";if(this.addressPattern=e(arguments[0]),f>1){for(g="",a=1;f>a;a++){if("number"==typeof arguments[a])g+=c(arguments[a])?"i":"f";else if("string"==typeof arguments[a])g+="s";else{if(!(arguments[a]instanceof Blob))throw"OSCMessage Error: unknown argument type";g+="b"}this.args.push(arguments[a])}this.typesString=g}}return!0};r.prototype.address=function(a){if(!a)return this.addressPattern;if("string"!=typeof a&&!b(a))throw"OSC.Message Error: first argument (path) must be a string or array";this.addressPattern=e(a)},r.prototype.add=function(a){if(!a)return!1;var b;if("number"==typeof a)b=a%1===0?"i":"f";else if("string"==typeof a)b="s";else{if(!(a instanceof Blob))throw"OSCMessage Error: unknown argument type";b="b"}this.args.push(a),this.typesString=this.typesString+b},r.prototype.decode=function(a){var b,c,d,e,f;if(b=new o.OSCString,b.decode(a,0),c=new o.OSCString,c.decode(a,b.offset),0===c.length||","!==c.value[0])throw"OSCMessage Error: malformed or missing OSC TypeString";for(e=[],f=c.offset,d=1;d<c.value.length;d++){var g;if("i"===c.value[d])g=new o.Int32;else if("f"===c.value[d])g=new o.Float32;else if("s"===c.value[d])g=new o.OSCString;else{if("b"!==c.value[d])throw"OSCMessage Error: found nonstandard argument type";g=new o.OSCBlob}g.decode(a,f),f=g.offset,e.push(g.value)}return this.addressPattern=b.value,this.typesString=c.value.slice(1,c.value.length),this.args=e,this},r.prototype.encode=function(){if(0===this.addressPattern.length||"/"!==this.addressPattern[0])throw"OSCMessage Error: proper address is needed to encode this message";var a=new l;if(a.add(new o.OSCString(this.addressPattern)),this.args.length>0){a.add(new o.OSCString(","+this.typesString));var b;this.args.forEach(function(c){if("number"==typeof c)b=c%1===0?new o.Int32(c):new o.Float32(c);else if("string"==typeof c)b=new o.OSCString(c);else{if(!(c instanceof Blob))throw"OSCMessage Error: unknown argument type";b=new o.OSCBlob(c)}a.add(b)})}return a.merge()};var s,t,u=function(a){return a&&Object.keys(a).forEach(function(b){b in h&&(h[b]=a[b])}),this.SOCKET=g.SOCKET,s=new m,t=new n,!0};u.prototype.on=function(a,b){return s.on(a,b)},u.prototype.off=function(a,b){return s.off(a,b)},u.prototype.connect=function(a,b){var c=a||j,d=b||k;return t.connect(c,d)},u.prototype.disconnect=function(){return t.disconnect()},u.prototype.status=function(){return t.status()},u.prototype.send=function(a){if(!(a instanceof r||a instanceof q))throw"OSC Error: packet must be an OSCMessage or OSCBundle instance";var b=new p;return t.send(b.encode(a))},a.OSC=u,a.OSC.Message=r,a.OSC.Bundle=q}(window);
//# sourceMappingURL=osc.min.map
